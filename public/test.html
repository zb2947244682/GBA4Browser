<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mGBA Direct Test</title>
  <style>
    body {
      background: #121212;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding: 0;
      margin: 0;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    canvas {
      display: block;
      margin: 0 auto;
      border: 2px solid red;
      background: black;
      image-rendering: pixelated;
    }
    
    button, input {
      margin: 10px;
      padding: 8px 16px;
    }
    
    #log {
      background: #1a1a1a;
      border: 1px solid #333;
      text-align: left;
      padding: 10px;
      margin: 20px auto;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>mGBA Direct Test</h1>
    
    <canvas id="canvas" width="240" height="160"></canvas>
    
    <div class="controls">
      <input type="file" id="rom-input" accept=".gba">
      <button id="start-button">Start Game</button>
      <button id="refresh-button">Refresh Screen</button>
    </div>
    
    <div id="log"></div>
  </div>

  <script type="module">
    // Global variables
    let mgba = null;
    const canvas = document.getElementById('canvas');
    const log = document.getElementById('log');
    const romInput = document.getElementById('rom-input');
    const startButton = document.getElementById('start-button');
    const refreshButton = document.getElementById('refresh-button');
    
    // Log function
    function logMessage(message) {
      console.log(message);
      log.textContent += message + '\n';
      log.scrollTop = log.scrollHeight;
    }
    
    // Initialize mGBA
    async function initEmulator() {
      try {
        logMessage('Initializing mGBA...');
        
        // Draw loading text on canvas
        const ctx = canvas.getContext('2d');
        if (ctx) {
          ctx.fillStyle = 'black';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = 'white';
          ctx.font = '16px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('Loading...', canvas.width/2, canvas.height/2);
        }
        
        // Import mGBA module
        const mGBAModule = await import('./mgba.js');
        
        // Initialize module with canvas
        mgba = await mGBAModule.default({
          canvas,
          locateFile: (path) => {
            if (path.endsWith('.wasm')) {
              logMessage(`Loading WASM from: ${path}`);
              return '/mgba.wasm';
            }
            return path;
          },
          print: (text) => logMessage(`mGBA stdout: ${text}`),
          printErr: (text) => logMessage(`mGBA stderr: ${text}`),
          audioBufferSize: 1024,
          audioSampleRate: 44100
        });
        
        // Initialize file system
        await mgba.FSInit();
        logMessage('File system initialized');
        
        // Try to set core settings
        if (typeof mgba.setCoreSettings === 'function') {
          mgba.setCoreSettings({
            skipBios: true,
            useBios: false,
            sampleRate: 44100,
            audioSync: true,
            videoSync: true,
            volume: 100,
            mute: false,
            frameskip: 0,
            fpsTarget: 60
          });
          logMessage('Core settings applied');
        }
        
        // Log available methods
        logMessage('Available methods:');
        Object.keys(mgba)
          .filter(key => typeof mgba[key] === 'function')
          .slice(0, 10) // Just log first few methods to avoid flooding
          .forEach(method => logMessage(`- ${method}`));
        
        logMessage('mGBA initialized successfully!');
        
      } catch (error) {
        logMessage(`Initialization error: ${error.message || error}`);
        console.error(error);
      }
    }
    
    // Load ROM
    function loadROM(file) {
      if (!file || !mgba) return;
      
      logMessage(`Loading ROM: ${file.name} (${file.size} bytes)`);
      
      try {
        mgba.uploadRom(file, () => {
          logMessage('ROM loaded successfully');
          
          // Start game after short delay
          setTimeout(startGame, 100);
        });
      } catch (error) {
        logMessage(`Error loading ROM: ${error.message || error}`);
      }
    }
    
    // Start game
    function startGame() {
      if (!mgba) return;
      
      logMessage('Starting game...');
      
      try {
        // Pause first in case it's already running
        mgba.pauseMainLoop();
        mgba.pauseGame();
        mgba.pauseAudio();
        
        // Make sure canvas size is correct
        canvas.width = 240;
        canvas.height = 160;
        
        // Try to set canvas size through module
        if (typeof mgba.setCanvasSize === 'function') {
          mgba.setCanvasSize(240, 160);
        }
        
        // Resume game
        mgba.resumeMainLoop();
        mgba.resumeGame();
        mgba.resumeAudio();
        
        // Force refresh after a short delay
        setTimeout(refreshScreen, 500);
        
      } catch (error) {
        logMessage(`Error starting game: ${error.message || error}`);
      }
    }
    
    // Refresh screen
    function refreshScreen() {
      if (!mgba) return;
      
      logMessage('Refreshing screen...');
      
      try {
        // Try to capture screenshot to force refresh
        if (typeof mgba.screenshot === 'function') {
          mgba.screenshot();
        }
        
        // Pause and resume to force redraw
        mgba.pauseMainLoop();
        mgba.pauseGame();
        
        setTimeout(() => {
          mgba.resumeMainLoop();
          mgba.resumeGame();
          logMessage('Screen refresh completed');
        }, 100);
        
      } catch (error) {
        logMessage(`Error refreshing screen: ${error.message || error}`);
      }
    }
    
    // Event handlers
    romInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) loadROM(file);
    });
    
    startButton.addEventListener('click', startGame);
    refreshButton.addEventListener('click', refreshScreen);
    
    // Initialize on page load
    window.onload = initEmulator;
  </script>
</body>
</html> 