<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GBA4Browser独立版</title>
  <style>
    body {
      background: #121212;
      color: #eaeaea;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 2rem;
      color: #61dafb;
      margin-bottom: 20px;
    }
    
    .emulator {
      margin: 20px auto;
      position: relative;
    }
    
    #gba-canvas {
      display: block;
      margin: 0 auto;
      width: 240px;
      height: 160px;
      background: #000;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }
    
    .canvas-container {
      position: relative;
      width: 240px;
      height: 160px;
      margin: 0 auto;
      border: 2px solid #333;
      background: #000;
    }
    
    .controls {
      margin: 20px 0;
    }
    
    button {
      background: #2a2a2a;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
      font-weight: 600;
    }
    
    button:hover:not(:disabled) {
      background: #3a3a3a;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .file-input {
      margin: 15px 0;
    }
    
    .file-input input {
      margin: 10px 0;
    }
    
    .status {
      background: #1a1a1a;
      padding: 10px;
      border-radius: 4px;
      margin: 20px auto;
      max-width: 80%;
      min-height: 30px;
      text-align: center;
    }
    
    .keys {
      margin: 20px auto;
      max-width: 400px;
      background: #1a1a1a;
      padding: 15px;
      border-radius: 4px;
      text-align: left;
    }
    
    .keys h3 {
      margin-top: 0;
      color: #61dafb;
    }
    
    .keys p {
      margin: 5px 0;
      font-family: monospace;
    }
    
    .debug {
      margin-top: 30px;
      padding: 10px;
      border: 1px solid #333;
      text-align: left;
      background: #111;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>GBA4Browser独立版</h1>
    
    <div class="emulator">
      <div class="canvas-container">
        <canvas id="gba-canvas" width="240" height="160"></canvas>
      </div>
      
      <div class="status" id="status">
        等待初始化...
      </div>
      
      <div class="file-input">
        <input type="file" id="rom-input" accept=".gba">
      </div>
      
      <div class="controls">
        <button id="start-btn" disabled>开始</button>
        <button id="pause-btn" disabled>暂停</button>
        <button id="reset-btn" disabled>重置</button>
        <button id="refresh-btn" disabled>刷新画面</button>
      </div>
    </div>
    
    <div class="keys">
      <h3>控制方式:</h3>
      <p>方向键: 上下左右</p>
      <p>A 键: Z</p>
      <p>B 键: X</p>
      <p>L 键: A</p>
      <p>R 键: S</p>
      <p>开始: Enter</p>
      <p>选择: Backspace</p>
    </div>
    
    <div class="debug" id="debug"></div>
  </div>
  
  <script type="text/javascript">
    // DOM 元素
    const canvas = document.getElementById('gba-canvas');
    const status = document.getElementById('status');
    const debug = document.getElementById('debug');
    const romInput = document.getElementById('rom-input');
    const startButton = document.getElementById('start-btn');
    const pauseButton = document.getElementById('pause-btn');
    const resetButton = document.getElementById('reset-btn');
    const refreshButton = document.getElementById('refresh-btn');
    
    // 状态变量
    let mgba = null;
    let isInitialized = false;
    let isGameLoaded = false;
    let isPaused = true;
    
    // 键盘映射
    const KEY_BINDINGS = {
      'z': 0,          // A
      'x': 1,          // B
      'Backspace': 2,  // SELECT
      'Enter': 3,      // START
      'ArrowRight': 4, // RIGHT
      'ArrowLeft': 5,  // LEFT
      'ArrowUp': 6,    // UP
      'ArrowDown': 7,  // DOWN
      's': 8,          // R
      'a': 9           // L
    };
    
    // 调试日志
    function log(message) {
      console.log(message);
      const time = new Date().toLocaleTimeString();
      debug.textContent += `[${time}] ${message}\n`;
      debug.scrollTop = debug.scrollHeight;
    }
    
    // 更新状态显示
    function updateStatus(message) {
      status.textContent = message;
      log(message);
    }
    
    // 设置按钮状态
    function updateButtons() {
      startButton.disabled = !isInitialized || (isGameLoaded && !isPaused);
      pauseButton.disabled = !isInitialized || !isGameLoaded || isPaused;
      resetButton.disabled = !isInitialized || !isGameLoaded;
      refreshButton.disabled = !isInitialized || !isGameLoaded;
      
      romInput.disabled = !isInitialized;
    }
    
    // 初始化Canvas
    function setupCanvas() {
      const ctx = canvas.getContext('2d');
      if (ctx) {
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#222222';
        ctx.fillRect(10, 10, canvas.width - 20, canvas.height - 20);
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('等待ROM加载...', canvas.width / 2, canvas.height / 2);
      }
    }
    
    // 初始化mGBA
    async function initEmulator() {
      try {
        updateStatus('初始化mGBA...');
        
        // 设置Canvas
        setupCanvas();
        
        // 动态导入mGBA模块
        const mGBAModule = await import('./mgba.js');
        
        // 创建mGBA实例
        mgba = await mGBAModule.default({
          canvas,
          locateFile: (path) => {
            if (path.endsWith('.wasm')) {
              log(`加载WASM: ${path}`);
              return '/mgba.wasm';
            }
            return path;
          },
          print: (text) => log(`mGBA stdout: ${text}`),
          printErr: (text) => log(`mGBA stderr: ${text}`),
          audioBufferSize: 2048,
          audioSampleRate: 44100,
          frameskip: 0,
          // 增加内存分配
          wasmMemory: new WebAssembly.Memory({
            initial: 32 * 1024 * 1024 / 65536,
            maximum: 32 * 1024 * 1024 / 65536
          })
        });
        
        log('mGBA模块已加载');
        
        // 初始化文件系统
        await mgba.FSInit();
        log('文件系统已初始化');
        
        // 应用核心设置
        if (typeof mgba.setCoreSettings === 'function') {
          mgba.setCoreSettings({
            skipBios: true,
            useBios: false,
            sampleRate: 44100,
            audioSync: true,
            videoSync: true,
            volume: 100,
            mute: false,
            frameskip: 0,
            fpsTarget: 60
          });
          log('核心设置已应用');
        }
        
        // 设置按键绑定
        setupKeyBindings();
        
        isInitialized = true;
        updateStatus('模拟器初始化完成，请加载ROM');
        updateButtons();
      } catch (error) {
        updateStatus(`初始化失败: ${error}`);
        console.error(error);
      }
    }
    
    // 加载ROM
    function loadROM(file) {
      if (!file || !mgba || !isInitialized) return;
      
      try {
        updateStatus(`正在加载ROM: ${file.name}`);
        
        // 检查文件大小
        if (file.size < 1024) {
          updateStatus('ROM文件太小，可能不是有效的GBA ROM');
          return;
        }
        
        if (file.size > 32 * 1024 * 1024) {
          updateStatus('ROM文件太大，超过32MB');
          return;
        }
        
        // 如果已经加载了游戏，停止它
        if (isGameLoaded) {
          pauseGame();
          if (typeof mgba.quitGame === 'function') {
            mgba.quitGame();
          }
        }
        
        // 上传ROM
        mgba.uploadRom(file, () => {
          log('ROM上传成功');
          
          // 清空画布
          const ctx = canvas.getContext('2d');
          if (ctx) {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          }
          
          // 立即启动游戏
          startGame();
          
          isGameLoaded = true;
          isPaused = false;
          updateStatus('游戏已加载并运行中');
          updateButtons();
          
          // 强制刷新一次画面
          setTimeout(refreshScreen, 500);
        });
      } catch (error) {
        updateStatus(`加载ROM失败: ${error}`);
        console.error(error);
      }
    }
    
    // 启动游戏
    function startGame() {
      if (!mgba || !isInitialized) return;
      
      try {
        log('启动游戏');
        
        // 确保画布大小正确
        canvas.width = 240;
        canvas.height = 160;
        
        // 尝试设置Canvas大小
        if (typeof mgba.setCanvasSize === 'function') {
          mgba.setCanvasSize(240, 160);
        }
        
        // 启动主循环和游戏
        mgba.resumeMainLoop();
        mgba.resumeGame();
        mgba.resumeAudio();
        
        isPaused = false;
        updateStatus('游戏运行中');
        updateButtons();
      } catch (error) {
        updateStatus(`启动游戏失败: ${error}`);
        console.error(error);
      }
    }
    
    // 暂停游戏
    function pauseGame() {
      if (!mgba || !isInitialized || !isGameLoaded) return;
      
      try {
        log('暂停游戏');
        
        // 暂停主循环和游戏
        mgba.pauseMainLoop();
        mgba.pauseGame();
        mgba.pauseAudio();
        
        isPaused = true;
        updateStatus('游戏已暂停');
        updateButtons();
      } catch (error) {
        updateStatus(`暂停游戏失败: ${error}`);
        console.error(error);
      }
    }
    
    // 重置游戏
    function resetGame() {
      if (!mgba || !isInitialized || !isGameLoaded) return;
      
      try {
        log('重置游戏');
        
        // 重置游戏
        if (typeof mgba.quickReload === 'function') {
          mgba.quickReload();
          
          // 如果是暂停状态，恢复游戏
          if (isPaused) {
            startGame();
          }
          
          updateStatus('游戏已重置');
          
          // 强制刷新画面
          setTimeout(refreshScreen, 200);
        } else {
          updateStatus('不支持重置游戏');
        }
      } catch (error) {
        updateStatus(`重置游戏失败: ${error}`);
        console.error(error);
      }
    }
    
    // 刷新屏幕
    function refreshScreen() {
      if (!mgba || !isInitialized || !isGameLoaded) return;
      
      try {
        log('刷新画面');
        
        // 尝试截图强制刷新
        if (typeof mgba.screenshot === 'function') {
          mgba.screenshot();
        }
        
        // 暂停并恢复以强制重绘
        const wasPaused = isPaused;
        
        if (!wasPaused) {
          pauseGame();
        }
        
        // 确保Canvas尺寸正确
        canvas.width = 240;
        canvas.height = 160;
        
        // 更新Canvas大小
        if (typeof mgba.setCanvasSize === 'function') {
          mgba.setCanvasSize(240, 160);
        }
        
        if (!wasPaused) {
          setTimeout(() => {
            startGame();
            log('画面刷新完成');
          }, 100);
        }
      } catch (error) {
        updateStatus(`刷新画面失败: ${error}`);
        console.error(error);
      }
    }
    
    // 设置键盘控制
    function setupKeyBindings() {
      // 按键按下
      document.addEventListener('keydown', (e) => {
        if (!mgba || !isInitialized || !isGameLoaded || isPaused) return;
        
        const key = KEY_BINDINGS[e.key];
        if (key !== undefined) {
          mgba.buttonPress(key);
          e.preventDefault();
        }
      });
      
      // 按键释放
      document.addEventListener('keyup', (e) => {
        if (!mgba || !isInitialized || !isGameLoaded || isPaused) return;
        
        const key = KEY_BINDINGS[e.key];
        if (key !== undefined) {
          mgba.buttonUnpress(key);
          e.preventDefault();
        }
      });
    }
    
    // 事件处理器
    romInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) loadROM(file);
    });
    
    startButton.addEventListener('click', startGame);
    pauseButton.addEventListener('click', pauseGame);
    resetButton.addEventListener('click', resetGame);
    refreshButton.addEventListener('click', refreshScreen);
    
    // 初始化
    window.addEventListener('DOMContentLoaded', initEmulator);
  </script>
</body>
</html> 