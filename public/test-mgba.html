<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mGBA Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #242424;
      color: white;
    }
    
    canvas {
      border: 2px solid red;
      margin: 20px 0;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }
    
    button {
      margin: 5px;
      padding: 8px 16px;
      background-color: #1a1a1a;
      color: white;
      border: 1px solid #646cff;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:hover {
      background-color: #2a2a2a;
    }
    
    #log {
      width: 90%;
      height: 200px;
      background-color: #1a1a1a;
      color: #ddd;
      font-family: monospace;
      padding: 10px;
      overflow-y: auto;
      border-radius: 4px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>mGBA WebAssembly Test</h1>
  
  <canvas id="canvas" width="240" height="160"></canvas>
  
  <div>
    <input type="file" id="rom-input" accept=".gba">
    <button id="start-btn">Start</button>
    <button id="pause-btn">Pause</button>
    <button id="reset-btn">Reset</button>
    <button id="screenshot-btn">Screenshot</button>
  </div>
  
  <div id="log"></div>
  
  <script type="module">
    // 导入 mGBA
    import mGBA from '/node_modules/@thenick775/mgba-wasm/dist/mgba.js';
    
    // DOM 元素
    const canvas = document.getElementById('canvas');
    const romInput = document.getElementById('rom-input');
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const screenshotBtn = document.getElementById('screenshot-btn');
    const logEl = document.getElementById('log');
    
    // 日志函数
    function log(message) {
      console.log(message);
      logEl.innerHTML += `${message}<br>`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    // GBA 按键映射
    const GBA_KEYS = {
      A: 0,
      B: 1,
      SELECT: 2,
      START: 3,
      RIGHT: 4,
      LEFT: 5,
      UP: 6,
      DOWN: 7,
      R: 8,
      L: 9
    };
    
    // 键盘映射
    const KEY_BINDINGS = {
      'z': GBA_KEYS.A,
      'x': GBA_KEYS.B,
      'Backspace': GBA_KEYS.SELECT,
      'Enter': GBA_KEYS.START,
      'ArrowRight': GBA_KEYS.RIGHT,
      'ArrowLeft': GBA_KEYS.LEFT,
      'ArrowUp': GBA_KEYS.UP,
      'ArrowDown': GBA_KEYS.DOWN,
      's': GBA_KEYS.R,
      'a': GBA_KEYS.L
    };
    
    // 初始化 mGBA
    let Module = null;
    
    async function initEmulator() {
      try {
        log('正在初始化 mGBA...');
        
        Module = await mGBA({
          canvas,
          locateFile: (path, prefix) => {
            if (path.endsWith('.wasm')) {
              log(`加载 WebAssembly 文件: /mgba.wasm`);
              return '/mgba.wasm';
            }
            return prefix + path;
          },
          print: (text) => log(`mGBA stdout: ${text}`),
          printErr: (text) => log(`mGBA stderr: ${text}`),
          onRuntimeInitialized: () => {
            log('Runtime 初始化完成');
          }
        });
        
        log(`mGBA 版本: ${Module.version.projectName} ${Module.version.projectVersion}`);
        
        await Module.FSInit();
        log('文件系统初始化完成');
        
        log('可用方法:');
        Object.keys(Module).filter(key => typeof Module[key] === 'function').forEach(method => {
          log(`- ${method}`);
        });
        
        setupEventListeners();
        
        log('mGBA 初始化完成');
      } catch (err) {
        log(`初始化错误: ${err}`);
      }
    }
    
    function setupEventListeners() {
      // ROM 加载
      romInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        log(`加载 ROM: ${file.name} (${file.size} 字节)`);
        
        Module.uploadRom(file, () => {
          log('ROM 加载完成');
          
          // 启动游戏
          Module.resumeMainLoop();
          Module.resumeGame();
          Module.resumeAudio();
          
          log('游戏已启动');
        });
      });
      
      // 开始按钮
      startBtn.addEventListener('click', () => {
        log('恢复游戏');
        Module.resumeMainLoop();
        Module.resumeGame();
        Module.resumeAudio();
      });
      
      // 暂停按钮
      pauseBtn.addEventListener('click', () => {
        log('暂停游戏');
        Module.pauseMainLoop();
        Module.pauseGame();
        Module.pauseAudio();
      });
      
      // 重置按钮
      resetBtn.addEventListener('click', () => {
        log('重置游戏');
        Module.quickReload();
      });
      
      // 截图按钮
      screenshotBtn.addEventListener('click', () => {
        log('截图');
        Module.screenshot();
      });
      
      // 键盘控制
      window.addEventListener('keydown', (e) => {
        const key = KEY_BINDINGS[e.key];
        if (key !== undefined) {
          Module.buttonPress(key);
          log(`按下: ${e.key} -> ${key}`);
          e.preventDefault();
        }
      });
      
      window.addEventListener('keyup', (e) => {
        const key = KEY_BINDINGS[e.key];
        if (key !== undefined) {
          Module.buttonUnpress(key);
          log(`释放: ${e.key} -> ${key}`);
          e.preventDefault();
        }
      });
    }
    
    // 初始化
    initEmulator();
  </script>
</body>
</html>