<!DOCTYPE html>
<html>
<head>
  <title>mGBA Debug</title>
  <style>
    body { background: #222; color: #ddd; font-family: sans-serif; text-align: center; }
    canvas { 
      border: 3px solid red; 
      display: block; 
      margin: 20px auto;
      background: black;
    }
    button { margin: 5px; padding: 8px 15px; }
    #log { 
      font-family: monospace; 
      text-align: left; 
      height: 200px; 
      overflow-y: auto; 
      background: #111; 
      padding: 10px;
      white-space: pre;
    }
  </style>
  <!-- 直接引入 mgba.js -->
  <script src="./mgba.js"></script>
</head>
<body>
  <h1>mGBA Minimal Debug</h1>
  
  <!-- 使用固定尺寸的canvas -->
  <canvas id="gba-canvas" width="240" height="160"></canvas>
  
  <div>
    <input type="file" id="rom-file" accept=".gba">
    <button id="start">Start Game</button>
    <button id="refresh">Refresh Screen</button>
  </div>
  
  <div id="log"></div>
  
  <script>
    const canvas = document.getElementById('gba-canvas');
    const romFile = document.getElementById('rom-file');
    const startButton = document.getElementById('start');
    const refreshButton = document.getElementById('refresh');
    const logElement = document.getElementById('log');
    
    let mgba = null;
    
    function log(text) {
      console.log(text);
      logElement.textContent += text + '\n';
      logElement.scrollTop = logElement.scrollHeight;
    }

    // 主初始化函数
    async function init() {
      try {
        log('加载 mGBA...');
        
        // 检查 mGBA 是否已定义
        if (typeof mGBA === 'undefined') {
          log('mGBA 未定义 - 脚本可能未正确加载');
          return;
        }
        
        log('mGBA 脚本已找到');
        
        // 初始化 mGBA
        mgba = await mGBA({
          canvas,
          locateFile: (path, prefix) => {
            if (path.endsWith('.wasm')) {
              const wasmPath = './mgba.wasm'; // 使用复制到 public 目录的文件
              log(`加载 WASM 文件: ${wasmPath}`);
              return wasmPath;
            }
            return prefix + path;
          },
          print: (msg) => log(`stdout: ${msg}`),
          printErr: (msg) => log(`stderr: ${msg}`)
        });
        
        log(`mGBA 版本: ${mgba.version.projectName} ${mgba.version.projectVersion}`);
        
        await mgba.FSInit();
        log('文件系统初始化完成');
        
        // 设置按钮事件
        setupEvents();
        
        // 检查 canvas 状态
        const ctx = canvas.getContext('2d');
        
        // 在 canvas 上绘制一些内容进行测试
        ctx.fillStyle = 'green';
        ctx.fillRect(0, 0, 50, 50);
        ctx.fillStyle = 'blue';
        ctx.fillRect(50, 50, 50, 50);
        
        log('Canvas 测试绘制成功');
        log('初始化完成，请加载 ROM');
        
        // 添加所有可用方法
        log('可用方法:');
        Object.keys(mgba).filter(k => typeof mgba[k] === 'function').forEach(m => {
          log(`- ${m}`);
        });
      } catch (err) {
        log(`错误: ${err.message}`);
        console.error(err);
      }
    }
    
    function setupEvents() {
      romFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        log(`加载 ROM: ${file.name} (${file.size} 字节)`);
        
        try {
          mgba.uploadRom(file, () => {
            log('ROM 已成功上传');
          });
        } catch (err) {
          log(`ROM 加载错误: ${err.message}`);
          console.error(err);
        }
      });
      
      startButton.addEventListener('click', () => {
        try {
          log('开始游戏');
          
          // 尝试不同的启动方法组合
          try { mgba.resumeMainLoop(); } catch (e) { log(`resumeMainLoop 错误: ${e.message}`); }
          try { mgba.resumeGame(); } catch (e) { log(`resumeGame 错误: ${e.message}`); }
          try { mgba.resumeAudio(); } catch (e) { log(`resumeAudio 错误: ${e.message}`); }
          
          // 尝试绑定一些按键
          try {
            log('绑定按键');
            mgba.bindKey('ArrowUp', 6);    // Up
            mgba.bindKey('ArrowDown', 7);  // Down
            mgba.bindKey('ArrowLeft', 5);  // Left
            mgba.bindKey('ArrowRight', 4); // Right
            mgba.bindKey('z', 0);          // A
            mgba.bindKey('x', 1);          // B
          } catch(e) {
            log(`按键绑定错误: ${e.message}`);
          }
          
          // 尝试设置 canvas 尺寸
          try {
            if (mgba.setCanvasSize) {
              log('设置 canvas 尺寸');
              mgba.setCanvasSize(240, 160);
            }
          } catch(e) {
            log(`设置尺寸错误: ${e.message}`);
          }
          
          // 尝试单独调用 _main
          try {
            if (typeof mgba._main === 'function') {
              log('调用 _main 函数');
              mgba._main();
            }
          } catch(e) {
            log(`_main 调用错误: ${e.message}`);
          }
          
          // 尝试手动刷新
          setTimeout(() => {
            try { 
              mgba.screenshot(); 
              log('截图完成');
            } catch(e) { 
              log(`截图错误: ${e.message}`);
            } 
          }, 500);
        } catch (err) {
          log(`启动错误: ${err.message}`);
          console.error(err);
        }
      });
      
      refreshButton.addEventListener('click', () => {
        try {
          log('刷新画面');
          
          // 尝试截图强制刷新
          try { 
            mgba.screenshot();
            log('截图完成');
          } catch(e) {
            log(`截图错误: ${e.message}`);
          }
          
          // 暂停再恢复
          try { 
            mgba.pauseMainLoop();
            log('主循环已暂停');
          } catch(e) {
            log(`pauseMainLoop 错误: ${e.message}`);
          }
          
          try { 
            mgba.pauseGame();
            log('游戏已暂停');
          } catch(e) {
            log(`pauseGame 错误: ${e.message}`);
          }
          
          setTimeout(() => {
            try { 
              mgba.resumeMainLoop();
              log('主循环已恢复');
            } catch(e) {
              log(`resumeMainLoop 错误: ${e.message}`);
            }
            
            try { 
              mgba.resumeGame();
              log('游戏已恢复');
            } catch(e) {
              log(`resumeGame 错误: ${e.message}`);
            }
          }, 100);
          
          // 设置音量
          try { 
            if (mgba.setVolume) {
              log('设置音量');
              mgba.setVolume(100);
              log('音量已设置为 100%');
            }
          } catch(e) {
            log(`setVolume 错误: ${e.message}`);
          }
        } catch (err) {
          log(`刷新错误: ${err.message}`);
          console.error(err);
        }
      });
      
      // 键盘控制
      document.addEventListener('keydown', (e) => {
        if (!mgba || !mgba.buttonPress) return;
        
        const keyMap = {
          'ArrowUp': 6,
          'ArrowDown': 7,
          'ArrowLeft': 5,
          'ArrowRight': 4,
          'z': 0,
          'x': 1,
          'a': 9,
          's': 8,
          'Enter': 3,
          'Backspace': 2
        };
        
        const key = keyMap[e.key];
        if (key !== undefined) {
          try {
            mgba.buttonPress(key);
            log(`按下: ${e.key} -> ${key}`);
            e.preventDefault();
          } catch(err) {
            log(`buttonPress 错误: ${err.message}`);
          }
        }
      });
      
      document.addEventListener('keyup', (e) => {
        if (!mgba || !mgba.buttonUnpress) return;
        
        const keyMap = {
          'ArrowUp': 6,
          'ArrowDown': 7,
          'ArrowLeft': 5,
          'ArrowRight': 4,
          'z': 0,
          'x': 1,
          'a': 9,
          's': 8,
          'Enter': 3,
          'Backspace': 2
        };
        
        const key = keyMap[e.key];
        if (key !== undefined) {
          try {
            mgba.buttonUnpress(key);
            log(`释放: ${e.key} -> ${key}`);
            e.preventDefault();
          } catch(err) {
            log(`buttonUnpress 错误: ${err.message}`);
          }
        }
      });
    }
    
    // 在页面加载完成后启动初始化
    window.onload = init;
  </script>
</body>
</html> 