<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>mGBA æ¨¡æ‹Ÿå™¨</title>
  <link rel="stylesheet" href="css/styles.css">
  <script>
    // å…¨å±€é”™è¯¯å¤„ç†
    window.onerror = function(message, source, lineno, colno, error) {
      alert('å…¨å±€é”™è¯¯: ' + message);
      return true;
    };
    
    // ç¡®ä¿showLogså‡½æ•°åœ¨æ¨¡å—åŠ è½½å‰å¯ç”¨
    window.showLogs = function() {
      if (window._logContainer) {
        window._logContainer.style.display = 'flex';
        // ç¡®ä¿æ—¥å¿—å†…å®¹æ›´æ–°
        if (typeof window.updateLogDisplay === 'function') {
          window.updateLogDisplay();
        }
      } else {
        // å°è¯•åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
        if (typeof window.initLogger === 'function') {
          try {
            window.initLogger();
            setTimeout(function() {
              if (window._logContainer) {
                window._logContainer.style.display = 'flex';
              } else {
                alert('æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥');
              }
            }, 100);
          } catch (err) {
            alert('æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + err.message);
          }
        } else {
          alert('æ—¥å¿—ç³»ç»Ÿå°šæœªåŠ è½½');
        }
      }
    };
  </script>
</head>
<body>
  <div class="gameboy">
    <div id="emulator-container">
      <canvas id="gba-canvas"></canvas>
      <input type="file" id="rom-upload" accept=".gba,.gbc,.gb,.zip,.7z,.bin,.rom,.nes,.smc,.sfc,.md,.smd">
      <!-- å¾®ä¿¡ä¸“ç”¨æ–‡ä»¶ä¸Šä¼ æ§ä»¶ -->
      <input type="file" id="wechat-rom-upload" accept="*" style="display: none;">
      <div class="upload-text">ç‚¹å‡»å±å¹•ä¸Šä¼ ROM</div>
    </div>
    
    <div class="controls-area">
      <div class="shoulder-buttons">
        <div class="shoulder-button" ontouchstart="pressButton('l')" ontouchend="releaseButton('l')">L</div>
        <div class="shoulder-button" ontouchstart="pressButton('r')" ontouchend="releaseButton('r')">R</div>
      </div>
      
      <div class="main-controls">
        <div class="dpad">
          <div class="dpad-button dpad-up" ontouchstart="pressButton('up')" ontouchend="releaseButton('up')"></div>
          <div class="dpad-button dpad-right" ontouchstart="pressButton('right')" ontouchend="releaseButton('right')"></div>
          <div class="dpad-button dpad-down" ontouchstart="pressButton('down')" ontouchend="releaseButton('down')"></div>
          <div class="dpad-button dpad-left" ontouchstart="pressButton('left')" ontouchend="releaseButton('left')"></div>
          <div class="dpad-button dpad-center"></div>
        </div>
        
        <div class="action-buttons">
          <div class="round-button button-b" ontouchstart="pressButton('b')" ontouchend="releaseButton('b')">B</div>
          <div class="round-button button-a" ontouchstart="pressButton('a')" ontouchend="releaseButton('a')">A</div>
        </div>
      </div>
      
      <div class="menu-buttons">
        <div class="menu-button" ontouchstart="pressButton('select')" ontouchend="releaseButton('select')">SELECT</div>
        <div class="menu-button" ontouchstart="pressButton('start')" ontouchend="releaseButton('start')">START</div>
      </div>
    </div>
    
    <div class="function-bar">
      <div class="function-button" onclick="saveState()">
        <div class="function-icon">ğŸ’¾</div>
        <div>å­˜æ¡£</div>
      </div>
      <div class="function-button" onclick="loadState()">
        <div class="function-icon">ğŸ“‚</div>
        <div>è¯»æ¡£</div>
      </div>
      <div class="function-button" onclick="window.location.reload()">
        <div class="function-icon">ğŸ”„</div>
        <div>é‡ç½®</div>
      </div>
      <div class="function-button" onclick="showLogs()">
        <div class="function-icon">ğŸ“‹</div>
        <div>æ—¥å¿—</div>
      </div>
    </div>
  </div>

  <script type="module" src="js/main.js"></script>
  <script>
    // ç”¨äºå…¼å®¹ä¸æ”¯æŒESæ¨¡å—çš„æµè§ˆå™¨
    function fallbackLoad() {
      if (!window.module) {
        console.warn('ESæ¨¡å—åŠ è½½å¯èƒ½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ä¼ ç»Ÿè„šæœ¬åŠ è½½');
        
        // åŠ è½½å·¥å…·å‡½æ•°
        var utilsScript = document.createElement('script');
        utilsScript.src = 'js/utils-fallback.js';
        document.head.appendChild(utilsScript);
        
        // åŠ è½½æ§åˆ¶å™¨å‡½æ•°
        var controlsScript = document.createElement('script');
        controlsScript.src = 'js/controls-fallback.js';
        document.head.appendChild(controlsScript);
        
        // åŠ è½½æ—¥å¿—ç³»ç»Ÿ
        var loggerScript = document.createElement('script');
        loggerScript.src = 'js/logger-fallback.js';
        document.head.appendChild(loggerScript);
        
        // åŠ è½½å­˜æ¡£åŠŸèƒ½
        var saveloadScript = document.createElement('script');
        saveloadScript.src = 'js/saveload-fallback.js';
        document.head.appendChild(saveloadScript);
        
        // åŠ è½½æ¨¡æ‹Ÿå™¨
        var emulatorScript = document.createElement('script');
        emulatorScript.src = 'js/emulator-fallback.js';
        document.head.appendChild(emulatorScript);
      }
    }
    
    // 5ç§’åæ£€æŸ¥æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ
    setTimeout(fallbackLoad, 5000);
    
    // å®šä¹‰å…¨å±€æŒ‰é’®å‡½æ•°ï¼Œä»¥é˜²æ¨¡å—åŠ è½½å¤±è´¥
    function pressButton(button) {
      if (window.module) {
        window.module.buttonPress(button);
      } else {
        console.warn('æ¨¡æ‹Ÿå™¨æ¨¡å—æœªåŠ è½½ï¼ŒæŒ‰é’®æ“ä½œæ— æ•ˆ');
      }
    }
    
    function releaseButton(button) {
      if (window.module) {
        window.module.buttonUnpress(button);
      }
    }
    
    function saveState() {
      if (window.module) {
        if (window.module.saveStateSlot) {
          window.module.saveStateSlot(1);
          if (window.module.FSSync) {
            window.module.FSSync();
          }
        }
      } else {
        alert('æ¨¡æ‹Ÿå™¨æœªåŠ è½½ï¼Œæ— æ³•ä¿å­˜å­˜æ¡£');
      }
    }
    
    function loadState() {
      if (window.module) {
        if (window.module.loadStateSlot) {
          window.module.loadStateSlot(1);
        }
      } else {
        alert('æ¨¡æ‹Ÿå™¨æœªåŠ è½½ï¼Œæ— æ³•åŠ è½½å­˜æ¡£');
      }
    }
  </script>
</body>
</html>