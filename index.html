<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>mGBA æ¨¡æ‹Ÿå™¨</title>
  <link rel="stylesheet" href="css/styles.css">
  <script>
    // å…¨å±€é”™è¯¯å¤„ç†
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('å…¨å±€é”™è¯¯: ' + message);
      alert('å…¨å±€é”™è¯¯: ' + message);
      return true;
    };
    
    // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    window.showDebugInfo = function() {
      try {
        var debugInfo = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          vendor: navigator.vendor,
          language: navigator.language,
          screenSize: window.screen.width + 'x' + window.screen.height,
          devicePixelRatio: window.devicePixelRatio,
          isWeChat: /MicroMessenger/i.test(navigator.userAgent),
          moduleLoaded: !!window.module,
          canvasReady: !!document.getElementById('gba-canvas'),
          loggerReady: !!window._logContainer,
          wasmBinaryLoaded: !!window.wasmBinary,
          moduleProperties: window.module ? Object.keys(window.module) : []
        };
        
        var debugText = JSON.stringify(debugInfo, null, 2);
        console.log('è°ƒè¯•ä¿¡æ¯:', debugInfo);
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        var debugAlert = 'è°ƒè¯•ä¿¡æ¯:\n\n';
        for (var key in debugInfo) {
          if (key === 'moduleProperties') {
            debugAlert += key + ': ' + debugInfo[key].join(', ') + '\n';
          } else {
            debugAlert += key + ': ' + debugInfo[key] + '\n';
          }
        }
        
        alert(debugAlert);
        
        // å°è¯•è·å–æ›´å¤šæ¨¡å—ä¿¡æ¯
        if (window.module) {
          try {
            var moduleInfo = {
              hasUploadRom: typeof window.module.uploadRom === 'function',
              hasLoadGame: typeof window.module.loadGame === 'function',
              hasResumeGame: typeof window.module.resumeGame === 'function',
              hasFSInit: typeof window.module.FSInit === 'function',
              hasButtonPress: typeof window.module.buttonPress === 'function'
            };
            
            console.log('æ¨¡å—ä¿¡æ¯:', moduleInfo);
          } catch (err) {
            console.error('è·å–æ¨¡å—ä¿¡æ¯å¤±è´¥:', err);
          }
        }
      } catch (err) {
        alert('è·å–è°ƒè¯•ä¿¡æ¯å¤±è´¥: ' + err.message);
      }
    };
    
    // å†…è”æ—¥å¿—ç³»ç»Ÿï¼ˆç¡®ä¿åœ¨å¾®ä¿¡ç¯å¢ƒä¸­å¯ç”¨ï¼‰
    (function() {
      // åˆ›å»ºæ—¥å¿—å®¹å™¨
      function createLogContainer() {
        if (window._logContainer) return window._logContainer;
        
        var logContainer = document.createElement('div');
        logContainer.className = 'log-container';
        logContainer.style.position = 'fixed';
        logContainer.style.top = '0';
        logContainer.style.left = '0';
        logContainer.style.width = '100%';
        logContainer.style.height = '100%';
        logContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
        logContainer.style.zIndex = '100';
        logContainer.style.display = 'none';
        logContainer.style.flexDirection = 'column';
        logContainer.style.padding = '10px';
        logContainer.style.overflow = 'hidden';
        
        logContainer.innerHTML = `
          <div class="log-header" style="display:flex;justify-content:space-between;align-items:center;color:white;padding:10px 0;border-bottom:1px solid #444;margin-bottom:10px;">
            <div class="log-title" style="font-size:18px;font-weight:bold;">æ—¥å¿—</div>
            <button class="log-close" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">&times;</button>
          </div>
          <div class="log-content" style="flex:1;overflow-y:auto;color:#ddd;font-family:monospace;font-size:14px;white-space:pre-wrap;word-wrap:break-word;padding:10px 0;"></div>
          <div class="log-actions" style="display:flex;justify-content:space-between;padding:10px 0;border-top:1px solid #444;">
            <button class="log-button" id="log-clear" style="background-color:#444;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;">æ¸…é™¤æ—¥å¿—</button>
            <button class="log-button" id="log-copy" style="background-color:#444;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;">å¤åˆ¶æ—¥å¿—</button>
          </div>
        `;
        
        // ç¡®ä¿bodyå·²ç»åŠ è½½å®Œæˆ
        if (document.body) {
          document.body.appendChild(logContainer);
        } else {
          document.addEventListener('DOMContentLoaded', function() {
            document.body.appendChild(logContainer);
          });
        }
        
        window._logContainer = logContainer;
        window._logs = window._logs || [];
        
        return logContainer;
      }
      
      // æ·»åŠ æ—¥å¿—æ¡ç›®
      function addLogEntry(message, type) {
        var timestamp = new Date().toLocaleTimeString();
        var logEntry = {
          timestamp: timestamp,
          message: message,
          type: type || 'log'
        };
        
        if (!window._logs) window._logs = [];
        window._logs.push(logEntry);
        
        // é™åˆ¶æ—¥å¿—æ•°é‡
        if (window._logs.length > 1000) {
          window._logs.shift();
        }
        
        // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
        if (window._logContainer && window._logContainer.style.display === 'flex') {
          updateLogDisplay();
        }
      }
      
      // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
      function updateLogDisplay() {
        if (!window._logContainer) return;
        
        var logContent = window._logContainer.querySelector('.log-content');
        if (!logContent) return;
        
        logContent.innerHTML = '';
        
        window._logs.forEach(function(log) {
          var logElement = document.createElement('div');
          logElement.className = 'log-entry ' + log.type;
          logElement.textContent = '[' + log.timestamp + '] ' + log.message;
          
          // è®¾ç½®æ—¥å¿—æ¡ç›®æ ·å¼
          logElement.style.marginBottom = '5px';
          logElement.style.paddingBottom = '5px';
          logElement.style.borderBottom = '1px solid #333';
          
          // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
          if (log.type === 'error') {
            logElement.style.color = '#ff6b6b';
          } else if (log.type === 'warn') {
            logElement.style.color = '#feca57';
          } else if (log.type === 'info') {
            logElement.style.color = '#54a0ff';
          }
          
          logContent.appendChild(logElement);
        });
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        logContent.scrollTop = logContent.scrollHeight;
      }
      
      // é‡å†™æ§åˆ¶å°æ–¹æ³•
      var originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        info: console.info
      };
      
      console.log = function() {
        var args = Array.from(arguments);
        var message = args.map(function(arg) {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        
        addLogEntry(message, 'log');
        originalConsole.log.apply(console, arguments);
      };
      
      console.error = function() {
        var args = Array.from(arguments);
        var message = args.map(function(arg) {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        
        addLogEntry(message, 'error');
        originalConsole.error.apply(console, arguments);
      };
      
      console.warn = function() {
        var args = Array.from(arguments);
        var message = args.map(function(arg) {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        
        addLogEntry(message, 'warn');
        originalConsole.warn.apply(console, arguments);
      };
      
      console.info = function() {
        var args = Array.from(arguments);
        var message = args.map(function(arg) {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        
        addLogEntry(message, 'info');
        originalConsole.info.apply(console, arguments);
      };
      
      // æš´éœ²å…¨å±€å‡½æ•°
      window.showLogs = function() {
        var logContainer = createLogContainer();
        logContainer.style.display = 'flex';
        updateLogDisplay();
        
        // ç¡®ä¿äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š
        bindLogEvents(logContainer);
      };
      
      // ç»‘å®šæ—¥å¿—äº‹ä»¶
      function bindLogEvents(logContainer) {
        if (!logContainer) return;
        
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
        var closeBtn = logContainer.querySelector('.log-close');
        var clearBtn = logContainer.querySelector('#log-clear');
        var copyBtn = logContainer.querySelector('#log-copy');
        
        if (closeBtn) {
          var newCloseBtn = closeBtn.cloneNode(true);
          closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
          newCloseBtn.addEventListener('click', function() {
            logContainer.style.display = 'none';
            console.log('æ—¥å¿—é¢æ¿å·²å…³é—­');
          });
        }
        
        if (clearBtn) {
          var newClearBtn = clearBtn.cloneNode(true);
          clearBtn.parentNode.replaceChild(newClearBtn, clearBtn);
          newClearBtn.addEventListener('click', function() {
            window._logs = [];
            updateLogDisplay();
            console.log('æ—¥å¿—å·²æ¸…é™¤');
          });
        }
        
        if (copyBtn) {
          var newCopyBtn = copyBtn.cloneNode(true);
          copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);
          newCopyBtn.addEventListener('click', function() {
            try {
              var logText = window._logs.map(function(log) {
                return '[' + log.timestamp + '][' + log.type + '] ' + log.message;
              }).join('\n');
              
              var textarea = document.createElement('textarea');
              textarea.value = logText;
              textarea.style.position = 'fixed';
              textarea.style.left = '-9999px';
              document.body.appendChild(textarea);
              textarea.select();
              var successful = document.execCommand('copy');
              document.body.removeChild(textarea);
              
              if (successful) {
                alert('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
              } else {
                alert('å¤åˆ¶å¤±è´¥ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨ä¸æ”¯æŒ');
              }
            } catch (err) {
              alert('å¤åˆ¶æ—¥å¿—å¤±è´¥: ' + err.message);
            }
          });
        }
      }
      
      window.updateLogDisplay = updateLogDisplay;
      window.initLogger = function() {
        var logContainer = createLogContainer();
        bindLogEvents(logContainer);
        console.log('å†…è”æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
      };
      
      // è‡ªåŠ¨åˆå§‹åŒ–
      if (document.body) {
        var logContainer = createLogContainer();
        bindLogEvents(logContainer);
        console.log('å†…è”æ—¥å¿—ç³»ç»Ÿå·²è‡ªåŠ¨åˆå§‹åŒ–');
      } else {
        document.addEventListener('DOMContentLoaded', function() {
          var logContainer = createLogContainer();
          bindLogEvents(logContainer);
          console.log('å†…è”æ—¥å¿—ç³»ç»Ÿå·²è‡ªåŠ¨åˆå§‹åŒ–');
        });
      }
    })();
  </script>
</head>
<body>
  <div class="gameboy">
    <div id="emulator-container">
      <canvas id="gba-canvas"></canvas>
      <input type="file" id="rom-upload" accept=".gba,.gbc,.gb,.zip,.7z,.bin,.rom,.nes,.smc,.sfc,.md,.smd">
      <!-- å¾®ä¿¡ä¸“ç”¨æ–‡ä»¶ä¸Šä¼ æ§ä»¶ -->
      <input type="file" id="wechat-rom-upload" accept="*" style="display: none;">
      <div class="upload-text">ç‚¹å‡»å±å¹•ä¸Šä¼ ROM</div>
    </div>
    
    <div class="controls-area">
      <div class="shoulder-buttons">
        <div class="shoulder-button" ontouchstart="pressButton('l')" ontouchend="releaseButton('l')">L</div>
        <div class="shoulder-button" ontouchstart="pressButton('r')" ontouchend="releaseButton('r')">R</div>
      </div>
      
      <div class="main-controls">
        <div class="dpad">
          <div class="dpad-button dpad-up" ontouchstart="pressButton('up')" ontouchend="releaseButton('up')"></div>
          <div class="dpad-button dpad-right" ontouchstart="pressButton('right')" ontouchend="releaseButton('right')"></div>
          <div class="dpad-button dpad-down" ontouchstart="pressButton('down')" ontouchend="releaseButton('down')"></div>
          <div class="dpad-button dpad-left" ontouchstart="pressButton('left')" ontouchend="releaseButton('left')"></div>
          <div class="dpad-button dpad-center"></div>
        </div>
        
        <div class="action-buttons">
          <div class="round-button button-b" ontouchstart="pressButton('b')" ontouchend="releaseButton('b')">B</div>
          <div class="round-button button-a" ontouchstart="pressButton('a')" ontouchend="releaseButton('a')">A</div>
        </div>
      </div>
      
      <div class="menu-buttons">
        <div class="menu-button" ontouchstart="pressButton('select')" ontouchend="releaseButton('select')">SELECT</div>
        <div class="menu-button" ontouchstart="pressButton('start')" ontouchend="releaseButton('start')">START</div>
      </div>
    </div>
    
    <div class="function-bar">
      <div class="function-button" onclick="saveState()">
        <div class="function-icon">ğŸ’¾</div>
        <div>å­˜æ¡£</div>
      </div>
      <div class="function-button" onclick="loadState()">
        <div class="function-icon">ğŸ“‚</div>
        <div>è¯»æ¡£</div>
      </div>
      <div class="function-button" onclick="window.location.reload()">
        <div class="function-icon">ğŸ”„</div>
        <div>é‡ç½®</div>
      </div>
      <div class="function-button" onclick="showLogs()">
        <div class="function-icon">ğŸ“‹</div>
        <div>æ—¥å¿—</div>
      </div>
      <div class="function-button" onclick="showDebugInfo()">
        <div class="function-icon">ğŸ”</div>
        <div>è°ƒè¯•</div>
      </div>
    </div>
  </div>

  <script type="module" src="js/main.js"></script>
  <script>
    // ç”¨äºå…¼å®¹ä¸æ”¯æŒESæ¨¡å—çš„æµè§ˆå™¨
    function fallbackLoad() {
      if (!window.module) {
        console.warn('ESæ¨¡å—åŠ è½½å¯èƒ½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ä¼ ç»Ÿè„šæœ¬åŠ è½½');
        
        // åŠ è½½å·¥å…·å‡½æ•°
        var utilsScript = document.createElement('script');
        utilsScript.src = 'js/utils-fallback.js';
        document.head.appendChild(utilsScript);
        
        // åŠ è½½æ§åˆ¶å™¨å‡½æ•°
        var controlsScript = document.createElement('script');
        controlsScript.src = 'js/controls-fallback.js';
        document.head.appendChild(controlsScript);
        
        // åŠ è½½æ—¥å¿—ç³»ç»Ÿ
        var loggerScript = document.createElement('script');
        loggerScript.src = 'js/logger-fallback.js';
        document.head.appendChild(loggerScript);
        
        // åŠ è½½å­˜æ¡£åŠŸèƒ½
        var saveloadScript = document.createElement('script');
        saveloadScript.src = 'js/saveload-fallback.js';
        document.head.appendChild(saveloadScript);
        
        // åŠ è½½æ¨¡æ‹Ÿå™¨
        var emulatorScript = document.createElement('script');
        emulatorScript.src = 'js/emulator-fallback.js';
        document.head.appendChild(emulatorScript);
      }
    }
    
    // 5ç§’åæ£€æŸ¥æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ
    setTimeout(fallbackLoad, 5000);
    
    // å®šä¹‰å…¨å±€æŒ‰é’®å‡½æ•°ï¼Œä»¥é˜²æ¨¡å—åŠ è½½å¤±è´¥
    function pressButton(button) {
      if (window.module) {
        window.module.buttonPress(button);
      } else {
        console.warn('æ¨¡æ‹Ÿå™¨æ¨¡å—æœªåŠ è½½ï¼ŒæŒ‰é’®æ“ä½œæ— æ•ˆ');
      }
    }
    
    function releaseButton(button) {
      if (window.module) {
        window.module.buttonUnpress(button);
      }
    }
    
    function saveState() {
      if (window.module) {
        if (window.module.saveStateSlot) {
          window.module.saveStateSlot(1);
          if (window.module.FSSync) {
            window.module.FSSync();
          }
        }
      } else {
        alert('æ¨¡æ‹Ÿå™¨æœªåŠ è½½ï¼Œæ— æ³•ä¿å­˜å­˜æ¡£');
      }
    }
    
    function loadState() {
      if (window.module) {
        if (window.module.loadStateSlot) {
          window.module.loadStateSlot(1);
        }
      } else {
        alert('æ¨¡æ‹Ÿå™¨æœªåŠ è½½ï¼Œæ— æ³•åŠ è½½å­˜æ¡£');
      }
    }
  </script>
</body>
</html>