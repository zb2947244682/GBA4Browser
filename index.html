<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>mGBA 模拟器</title>
  <link rel="stylesheet" href="css/styles.css">
  <script>
    // 全局错误处理
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('全局错误: ' + message);
      alert('全局错误: ' + message);
      return true;
    };
    
    // 显示调试信息
    window.showDebugInfo = function() {
      try {
        var debugInfo = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          vendor: navigator.vendor,
          language: navigator.language,
          screenSize: window.screen.width + 'x' + window.screen.height,
          devicePixelRatio: window.devicePixelRatio,
          isWeChat: /MicroMessenger/i.test(navigator.userAgent),
          moduleLoaded: !!window.module,
          canvasReady: !!document.getElementById('gba-canvas'),
          loggerReady: !!window._logContainer,
          wasmBinaryLoaded: !!window.wasmBinary,
          moduleProperties: window.module ? Object.keys(window.module) : []
        };
        
        var debugText = JSON.stringify(debugInfo, null, 2);
        console.log('调试信息:', debugInfo);
        
        // 显示调试信息
        var debugAlert = '调试信息:\n\n';
        for (var key in debugInfo) {
          if (key === 'moduleProperties') {
            debugAlert += key + ': ' + debugInfo[key].join(', ') + '\n';
          } else {
            debugAlert += key + ': ' + debugInfo[key] + '\n';
          }
        }
        
        alert(debugAlert);
        
        // 尝试获取更多模块信息
        if (window.module) {
          try {
            var moduleInfo = {
              hasUploadRom: typeof window.module.uploadRom === 'function',
              hasLoadGame: typeof window.module.loadGame === 'function',
              hasResumeGame: typeof window.module.resumeGame === 'function',
              hasFSInit: typeof window.module.FSInit === 'function',
              hasButtonPress: typeof window.module.buttonPress === 'function'
            };
            
            console.log('模块信息:', moduleInfo);
          } catch (err) {
            console.error('获取模块信息失败:', err);
          }
        }
      } catch (err) {
        alert('获取调试信息失败: ' + err.message);
      }
    };
    
    // 内联日志系统（确保在微信环境中可用）
    (function() {
      // 创建日志容器
      function createLogContainer() {
        if (window._logContainer) return window._logContainer;
        
        var logContainer = document.createElement('div');
        logContainer.className = 'log-container';
        logContainer.style.position = 'fixed';
        logContainer.style.top = '0';
        logContainer.style.left = '0';
        logContainer.style.width = '100%';
        logContainer.style.height = '100%';
        logContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
        logContainer.style.zIndex = '100';
        logContainer.style.display = 'none';
        logContainer.style.flexDirection = 'column';
        logContainer.style.padding = '10px';
        logContainer.style.overflow = 'hidden';
        
        logContainer.innerHTML = `
          <div class="log-header" style="display:flex;justify-content:space-between;align-items:center;color:white;padding:10px 0;border-bottom:1px solid #444;margin-bottom:10px;">
            <div class="log-title" style="font-size:18px;font-weight:bold;">日志</div>
            <button class="log-close" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">&times;</button>
          </div>
          <div class="log-content" style="flex:1;overflow-y:auto;color:#ddd;font-family:monospace;font-size:14px;white-space:pre-wrap;word-wrap:break-word;padding:10px 0;"></div>
          <div class="log-actions" style="display:flex;justify-content:space-between;padding:10px 0;border-top:1px solid #444;">
            <button class="log-button" id="log-clear" style="background-color:#444;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;">清除日志</button>
            <button class="log-button" id="log-copy" style="background-color:#444;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;">复制日志</button>
          </div>
        `;
        
        // 确保body已经加载完成
        if (document.body) {
          document.body.appendChild(logContainer);
        } else {
          document.addEventListener('DOMContentLoaded', function() {
            document.body.appendChild(logContainer);
          });
        }
        
        window._logContainer = logContainer;
        window._logs = window._logs || [];
        
        return logContainer;
      }
      
      // 添加日志条目
      function addLogEntry(message, type) {
        var timestamp = new Date().toLocaleTimeString();
        var logEntry = {
          timestamp: timestamp,
          message: message,
          type: type || 'log'
        };
        
        if (!window._logs) window._logs = [];
        window._logs.push(logEntry);
        
        // 限制日志数量
        if (window._logs.length > 1000) {
          window._logs.shift();
        }
        
        // 更新日志显示
        if (window._logContainer && window._logContainer.style.display === 'flex') {
          updateLogDisplay();
        }
      }
      
      // 更新日志显示
      function updateLogDisplay() {
        if (!window._logContainer) return;
        
        var logContent = window._logContainer.querySelector('.log-content');
        if (!logContent) return;
        
        logContent.innerHTML = '';
        
        window._logs.forEach(function(log) {
          var logElement = document.createElement('div');
          logElement.className = 'log-entry ' + log.type;
          logElement.textContent = '[' + log.timestamp + '] ' + log.message;
          
          // 设置日志条目样式
          logElement.style.marginBottom = '5px';
          logElement.style.paddingBottom = '5px';
          logElement.style.borderBottom = '1px solid #333';
          
          // 根据类型设置颜色
          if (log.type === 'error') {
            logElement.style.color = '#ff6b6b';
          } else if (log.type === 'warn') {
            logElement.style.color = '#feca57';
          } else if (log.type === 'info') {
            logElement.style.color = '#54a0ff';
          }
          
          logContent.appendChild(logElement);
        });
        
        // 滚动到底部
        logContent.scrollTop = logContent.scrollHeight;
      }
      
      // 重写控制台方法
      var originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        info: console.info
      };
      
      console.log = function() {
        var args = Array.from(arguments);
        var message = args.map(function(arg) {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        
        addLogEntry(message, 'log');
        originalConsole.log.apply(console, arguments);
      };
      
      console.error = function() {
        var args = Array.from(arguments);
        var message = args.map(function(arg) {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        
        addLogEntry(message, 'error');
        originalConsole.error.apply(console, arguments);
      };
      
      console.warn = function() {
        var args = Array.from(arguments);
        var message = args.map(function(arg) {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        
        addLogEntry(message, 'warn');
        originalConsole.warn.apply(console, arguments);
      };
      
      console.info = function() {
        var args = Array.from(arguments);
        var message = args.map(function(arg) {
          if (typeof arg === 'object') {
            try {
              return JSON.stringify(arg);
            } catch (e) {
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        
        addLogEntry(message, 'info');
        originalConsole.info.apply(console, arguments);
      };
      
      // 暴露全局函数
      window.showLogs = function() {
        var logContainer = createLogContainer();
        logContainer.style.display = 'flex';
        updateLogDisplay();
        
        // 确保事件监听器已绑定
        bindLogEvents(logContainer);
      };
      
      // 绑定日志事件
      function bindLogEvents(logContainer) {
        if (!logContainer) return;
        
        // 移除旧的事件监听器（如果有）
        var closeBtn = logContainer.querySelector('.log-close');
        var clearBtn = logContainer.querySelector('#log-clear');
        var copyBtn = logContainer.querySelector('#log-copy');
        
        if (closeBtn) {
          var newCloseBtn = closeBtn.cloneNode(true);
          closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
          newCloseBtn.addEventListener('click', function() {
            logContainer.style.display = 'none';
            console.log('日志面板已关闭');
          });
        }
        
        if (clearBtn) {
          var newClearBtn = clearBtn.cloneNode(true);
          clearBtn.parentNode.replaceChild(newClearBtn, clearBtn);
          newClearBtn.addEventListener('click', function() {
            window._logs = [];
            updateLogDisplay();
            console.log('日志已清除');
          });
        }
        
        if (copyBtn) {
          var newCopyBtn = copyBtn.cloneNode(true);
          copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);
          newCopyBtn.addEventListener('click', function() {
            try {
              var logText = window._logs.map(function(log) {
                return '[' + log.timestamp + '][' + log.type + '] ' + log.message;
              }).join('\n');
              
              var textarea = document.createElement('textarea');
              textarea.value = logText;
              textarea.style.position = 'fixed';
              textarea.style.left = '-9999px';
              document.body.appendChild(textarea);
              textarea.select();
              var successful = document.execCommand('copy');
              document.body.removeChild(textarea);
              
              if (successful) {
                alert('日志已复制到剪贴板');
              } else {
                alert('复制失败，可能是浏览器不支持');
              }
            } catch (err) {
              alert('复制日志失败: ' + err.message);
            }
          });
        }
      }
      
      window.updateLogDisplay = updateLogDisplay;
      window.initLogger = function() {
        var logContainer = createLogContainer();
        bindLogEvents(logContainer);
        console.log('内联日志系统初始化完成');
      };
      
      // 自动初始化
      if (document.body) {
        var logContainer = createLogContainer();
        bindLogEvents(logContainer);
        console.log('内联日志系统已自动初始化');
      } else {
        document.addEventListener('DOMContentLoaded', function() {
          var logContainer = createLogContainer();
          bindLogEvents(logContainer);
          console.log('内联日志系统已自动初始化');
        });
      }
    })();
  </script>
</head>
<body>
  <div class="gameboy">
    <div id="emulator-container">
      <canvas id="gba-canvas"></canvas>
      <input type="file" id="rom-upload" accept=".gba,.gbc,.gb,.zip,.7z,.bin,.rom,.nes,.smc,.sfc,.md,.smd">
      <!-- 微信专用文件上传控件 -->
      <input type="file" id="wechat-rom-upload" accept="*" style="display: none;">
      <div class="upload-text">点击屏幕上传ROM</div>
    </div>
    
    <div class="controls-area">
      <div class="shoulder-buttons">
        <div class="shoulder-button" ontouchstart="pressButton('l')" ontouchend="releaseButton('l')">L</div>
        <div class="shoulder-button" ontouchstart="pressButton('r')" ontouchend="releaseButton('r')">R</div>
      </div>
      
      <div class="main-controls">
        <div class="dpad">
          <div class="dpad-button dpad-up" ontouchstart="pressButton('up')" ontouchend="releaseButton('up')"></div>
          <div class="dpad-button dpad-right" ontouchstart="pressButton('right')" ontouchend="releaseButton('right')"></div>
          <div class="dpad-button dpad-down" ontouchstart="pressButton('down')" ontouchend="releaseButton('down')"></div>
          <div class="dpad-button dpad-left" ontouchstart="pressButton('left')" ontouchend="releaseButton('left')"></div>
          <div class="dpad-button dpad-center"></div>
        </div>
        
        <div class="action-buttons">
          <div class="round-button button-b" ontouchstart="pressButton('b')" ontouchend="releaseButton('b')">B</div>
          <div class="round-button button-a" ontouchstart="pressButton('a')" ontouchend="releaseButton('a')">A</div>
        </div>
      </div>
      
      <div class="menu-buttons">
        <div class="menu-button" ontouchstart="pressButton('select')" ontouchend="releaseButton('select')">SELECT</div>
        <div class="menu-button" ontouchstart="pressButton('start')" ontouchend="releaseButton('start')">START</div>
      </div>
    </div>
    
    <div class="function-bar">
      <div class="function-button" onclick="saveState()">
        <div class="function-icon">💾</div>
        <div>存档</div>
      </div>
      <div class="function-button" onclick="loadState()">
        <div class="function-icon">📂</div>
        <div>读档</div>
      </div>
      <div class="function-button" onclick="window.location.reload()">
        <div class="function-icon">🔄</div>
        <div>重置</div>
      </div>
      <div class="function-button" onclick="showLogs()">
        <div class="function-icon">📋</div>
        <div>日志</div>
      </div>
      <div class="function-button" onclick="showDebugInfo()">
        <div class="function-icon">🔍</div>
        <div>调试</div>
      </div>
    </div>
  </div>

  <script type="module" src="js/main.js"></script>
  <script>
    // 用于兼容不支持ES模块的浏览器
    function fallbackLoad() {
      if (!window.module) {
        console.warn('ES模块加载可能失败，尝试使用传统脚本加载');
        
        // 加载工具函数
        var utilsScript = document.createElement('script');
        utilsScript.src = 'js/utils-fallback.js';
        document.head.appendChild(utilsScript);
        
        // 加载控制器函数
        var controlsScript = document.createElement('script');
        controlsScript.src = 'js/controls-fallback.js';
        document.head.appendChild(controlsScript);
        
        // 加载日志系统
        var loggerScript = document.createElement('script');
        loggerScript.src = 'js/logger-fallback.js';
        document.head.appendChild(loggerScript);
        
        // 加载存档功能
        var saveloadScript = document.createElement('script');
        saveloadScript.src = 'js/saveload-fallback.js';
        document.head.appendChild(saveloadScript);
        
        // 加载模拟器
        var emulatorScript = document.createElement('script');
        emulatorScript.src = 'js/emulator-fallback.js';
        document.head.appendChild(emulatorScript);
      }
    }
    
    // 5秒后检查模块是否加载成功
    setTimeout(fallbackLoad, 5000);
    
    // 定义全局按钮函数，以防模块加载失败
    function pressButton(button) {
      if (window.module) {
        window.module.buttonPress(button);
      } else {
        console.warn('模拟器模块未加载，按钮操作无效');
      }
    }
    
    function releaseButton(button) {
      if (window.module) {
        window.module.buttonUnpress(button);
      }
    }
    
    function saveState() {
      if (window.module) {
        if (window.module.saveStateSlot) {
          window.module.saveStateSlot(1);
          if (window.module.FSSync) {
            window.module.FSSync();
          }
        }
      } else {
        alert('模拟器未加载，无法保存存档');
      }
    }
    
    function loadState() {
      if (window.module) {
        if (window.module.loadStateSlot) {
          window.module.loadStateSlot(1);
        }
      } else {
        alert('模拟器未加载，无法加载存档');
      }
    }
  </script>
</body>
</html>